<% CASE '/balance' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{{ userlogs = user.services.list_for_api('usi', {}) }}
{{
    limit = 5;
    offset = args.1 || 0;
    userData = user.id(args.0);
    payData = userPay.comment.object;
    payMethod = payData.payment_method;
    payCard = payMethod.card;
    userPays = ref(userData.pays.list_for_api('limit', limit, 'offset', offset ));
}}
{{ last_payment = user.payments.last() }}
{{ forecast = user.pays.forecast }}
{{ user_services = ref(user.services.list_for_api('category', '%')) }}
{{ blocked_services = ref(user.services.list_for_api('category', '%', 'filter', { 'status' => 'BLOCK' })) }}
{{ expired_services = ref(user.services.list_for_api('category', '%', 'filter', { 'status' => 'NOT PAID' })) }}
{{ active_services = ref(user.services.list_for_api('category', '%', 'filter', { 'status' => 'ACTIVE' })) }}
{{ USE date }}

{
    "sendPhoto": {
        "photo": "{{ config.logo.url }}",
        "caption": "<blockquote>üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> {{ user.balance }} ‚ÇΩ\nüéÅ <b>–ë–æ–Ω—É—Å—ã:</b> {{ user.get_bonus }} ‚ÇΩ\nüîñ <b>–°–∫–∏–¥–∫–∞:</b> {{ user.discount }}%\nüë• <b>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π:</b> {{ user.referrals_count }}\nüí≥ <b>–û–±—â–∏–π –¥–æ—Ö–æ–¥ –æ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:</b> {{ user.get_bonus }} ‚ÇΩ\n\n‚è≥ <b>–°–ª–µ–¥—É—é—â–µ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ:</b> {{ IF userlogs.expire }}{{ date.format(userlogs.expire, '%H:%M %d.%m.%Y') }}{{ ELSE }}–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ{{ END }}\nüíµ <b>–û–∂–∏–¥–∞–µ–º–∞—è –æ–ø–ª–∞—Ç–∞:</b> {{ forecast.total }} ‚ÇΩ\n\nüîí <b>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:</b> ({{ blocked_services.size }})\n{{ FOR service IN blocked_services }}- {{ service.name }}\n{{ END }}\n\n‚ùó <b>–ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:</b> ({{ expired_services.size }})\n{{ FOR service IN expired_services }}- {{ service.name }}\n{{ END }}\n\n‚úÖ <b>–ê–∫—Ç–∏–≤–Ω—ã–µ —É—Å–ª—É–≥–∏:</b> ({{ active_services.size }})\n{{ IF active_services.size > 0 }}{{ FOR service IN active_services }}- {{ service.name }} (–¥–æ {{ date.format(service.expire, '%H:%M %d.%m.%Y') }})\n{{ END }}{{ ELSE }}–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å–ª—É–≥.{{ END }}\n\nüíµ <b>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å:</b> <b>{{ user.pays.forecast('blocked',1).total }} ‚ÇΩ</b></blockquote>",
		"parse_mode": "HTML",
        "reply_markup" : {
            "inline_keyboard": [
                [
                    {
                        "text": "‚úö –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å",
                        "web_app": {
                            "url": "{{ config.api.url }}/shm/v1/public/tg_payments_webapp?format=html&user_id={{ user.id }}"
                        }
                    }
                ],
                [
                    {
                        "text": "‚ò∞ –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π",
                        "callback_data": "/pays {{ userData.user_id }} {{ offset - limit }}"
                    }
                ],
                [
                    {
                        "text": "üåç –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
                        "callback_data": "/servers"
                    }
                ],
                [
                    {
                        "text": "üîÑ –û–±–Ω–æ–≤–∏—Ç—å",
                        "callback_data": "/balance"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}

<% CASE '/servers' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{{ vpn_mz_lt_servers = ref(user.services.list_for_api('category', 'vpn-mz-lt')) }}
{{ vpn_mz_usa_servers = ref(user.services.list_for_api('category', 'vpn-mz-usa')) }}
{{ vpn_mz_spain_servers = ref(user.services.list_for_api('category', 'vpn-mz-spain')) }}

{{ limit = 1 }}
{{ offset = args.0 || 0 }}

{
    "sendMessage": {
        "text": "<b>–°–µ—Ä–≤–µ—Ä–∞:</b>\n\n<b>vpn-mz-lt:</b>\n{{ IF vpn_mz_lt_servers.size > 0 }}{{ FOR server IN vpn_mz_lt_servers.slice(offset, limit) }}\nüåç –°–µ—Ä–≤–µ—Ä: {{ server.name }}\nüí° –°—Ç–∞—Ç—É—Å: {{ server.status }}\n‚è≥ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {{ server.expire }}\nüìä –¢—Ä–∞—Ñ–∏–∫: {{ server.traffic }}\nüè∑Ô∏è –°—Ç–æ–∏–º–æ—Å—Ç—å: {{ server.cost }} —Ä—É–±.\n{{ END }}{{ ELSE }}–ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ vpn-mz-lt.\n{{ END }}\n\n<b>vpn-mz-usa:</b>\n{{ IF vpn_mz_usa_servers.size > 0 }}{{ FOR server IN vpn_mz_usa_servers.slice(offset, limit) }}\nüåç –°–µ—Ä–≤–µ—Ä: {{ server.name }}\nüí° –°—Ç–∞—Ç—É—Å: {{ server.status }}\n‚è≥ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {{ server.expire }}\nüìä –¢—Ä–∞—Ñ–∏–∫: {{ server.traffic }}\nüè∑Ô∏è –°—Ç–æ–∏–º–æ—Å—Ç—å: {{ server.cost }} —Ä—É–±.\n{{ END }}{{ ELSE }}–ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ vpn-mz-usa.\n{{ END }}\n\n<b>vpn-mz-spain:</b>\n{{ IF vpn_mz_spain_servers.size > 0 }}{{ FOR server IN vpn_mz_spain_servers.slice(offset, limit) }}\nüåç –°–µ—Ä–≤–µ—Ä: {{ server.name }}\nüí° –°—Ç–∞—Ç—É—Å: {{ server.status }}\n‚è≥ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {{ server.expire }}\nüìä –¢—Ä–∞—Ñ–∏–∫: {{ server.traffic }}\nüè∑Ô∏è –°—Ç–æ–∏–º–æ—Å—Ç—å: {{ server.cost }} —Ä—É–±.\n{{ END }}{{ ELSE }}–ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ vpn-mz-spain.\n{{ END }}",
        "reply_markup": {
            "inline_keyboard": [
                [
                    {
                        "text": "üîÑ –û–±–Ω–æ–≤–∏—Ç—å",
                        "callback_data": "/servers {{ offset }}"
                    }
                ],
                [
                    {{ IF offset > 0 }}
                    {
                        "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                        "callback_data": "/servers {{ offset - limit }}"
                    },
                    {{ END }}
                    {{ IF vpn_mz_lt_servers.size > limit || vpn_mz_usa_servers.size > limit || vpn_mz_spain_servers.size > limit }}
                    {
                        "text": "–ï—â—ë ‚û°Ô∏è",
                        "callback_data": "/servers {{ offset + limit }}"
                    }
                    {{ END }}
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/balance"
                    }
                ]
            ]
        }
    }
}

<% CASE '/pays' %>
{
    "sendPhoto": {
        "photo": "{{ config.logo.url }}",
        "caption": "‚ò∞ <b>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</b>",
        "parse_mode": "HTML",
        "reply_markup": {
            "inline_keyboard": [
                {{
                    limit = 7;
                    offset = args.0 || 0;
                    offset = (offset < 0) ? 0 : offset;
                    pays = ref(user.pays.list_for_api('limit', limit, 'offset', offset));
                }}
                {{ IF pays.size > 0 }}
                    {{ FOR item in pays }}
                    {{ TEXT = BLOCK }}
üìÖ –î–∞—Ç–∞: {{ USE date }}{{ date.format(item.date, '%d.%m.%Y') }}  
üí∞ –°—É–º–º–∞: {{ item.money }} ‚ÇΩ
                    {{ END }}
                    [
                        {
                            "text": "{{ TEXT.replace('\n',' ') }}",
                            "callback_data": "/checkpay {{ item.id }}"
                        }
                    ],
                    {{ END }}
                {{ ELSE }}
                    [
                        {
                            "text": "‚ùóÔ∏è –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö.",
                            "callback_data": "/menu"
                        }
                    ],
                {{ END }}
                {{ IF pays.size == limit || offset > 0 }}
                [
                    {{ IF offset > 0 }}
                    {
                        "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                        "callback_data": "/pays {{ offset - limit }}"
                    },
                    {{ END }}
                    {{ IF pays.size == limit }}
                    {
                        "text": "‚û°Ô∏è –î–∞–ª–µ–µ",
                        "callback_data": "/pays {{ offset + limit }}"
                    }
                    {{ END }}
                ],
                {{ END }}
                [
                    {
                        "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}

<% CASE '/checkpay' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{{
    userPay = ref(pay.list_for_api('limit', 1, 'filter', {"id" = args.0})).first;
    payData = userPay.comment.object;
    payMethod = payData.payment_method;
    payCard = payMethod.card;
    userData = user.id(userPay.user_id);
}}
{{ TEXT = BLOCK }}
üí∏ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ</b>
üÜî <b>ID –ø–ª–∞—Ç–µ–∂–∞:</b> {{ userPay.id }}
üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {{ userData.full_name.replace('"', '"') }} ({{ userData.user_id }})

üìÖ <b>–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞:</b> {{ userPay.date }}
üí≥ <b>–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:</b> {{ userPay.pay_system_id }}
üí∞ <b>–°—É–º–º–∞:</b> {{ userPay.money }} —Ä—É–±.

{{ IF userPay.telegram_bot == 'telegram_bot' }}
‚≠ê <b>–û–ø–ª–∞—Ç–∞ –∑–≤–µ–∑–¥–∞–º–∏:</b> {{ userPay.currency }}
{{ END }}

{{ IF userPay.currency == 'XTR' }}
‚≠ê <b>–û–ø–ª–∞—Ç–∞ –∑–≤–µ–∑–¥–∞–º–∏:</b> {{ userPay.currency }}
{{ END }}

{{ IF userPay.comment.comment }}
üìù <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–ª–∞—Ç–µ–∂—É:</b>
<blockquote>{{ userPay.comment.comment }}</blockquote>
{{ END }}

{{ IF payData }}
üìÇ <b>–î–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞:</b>
<blockquote> üÜî <b>ID –≤ —Å–∏—Å—Ç–µ–º–µ:</b> {{ payData.id }}
üìä <b>–°—Ç–∞—Ç—É—Å:</b> {{ payData.status }}
{{ IF payCard }}
–¢–∏–ø –∫–∞—Ä—Ç—ã: {{ payCard.card_type }}
–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: {{ payCard.first6 }}******{{ payCard.last4 }}
–ë–∞–Ω–∫: {{ payCard.issuer_name }}
–°—Ç—Ä–∞–Ω–∞ –±–∞–Ω–∫–∞: {{ payCard.issuer_country }}
–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: {{ payCard.expiry_month }}/{{ payCard.expiry_year }}
{{ END }}
{{ IF payMethod.type == 'sbp' }}
–¢–∏–ø –æ–ø–ª–∞—Ç—ã: –°–ë–ü
–ù–æ–º–µ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –°–ë–ü: {{ payMethod.sbp_operation_id }}
–ë–∏–∫ –ë–∞–Ω–∫–∞: {{ payMethod.payer_bank_details.bic }}
{{ END }}

{{ IF payMethod.title.match('YooMoney') }}
–ö–æ—à–µ–ª–µ–∫ YooMoney: {{ payMethod.title }}
ID –∫–æ—à–µ–ª—å–∫–∞: {{ payMethod.account_number }}
{{ END }}
</blockquote>
{{ END }}

{{ END }}

{
    "sendMessage": {
        "text": "{{ TEXT.replace('\n','\n') }}\n",
        "reply_markup": {
            "inline_keyboard": [
                [
                    {
                        "text": "üîÑ –û–±–Ω–æ–≤–∏—Ç—å",
                        "callback_data": "/checkpay {{ args.0 }}"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥ ‚á¶",
                        "callback_data": "/pays"
                    }
                ]
            ]
        }
    }
}
