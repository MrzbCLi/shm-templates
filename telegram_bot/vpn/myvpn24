<% SWITCH cmd %>
<% CASE 'USER_NOT_FOUND' %>
{
    "shmRegister": {
        "partner_id": "{{ args.0 }}",
        "callback_data": "/start",
        "error": "–û–®–ò–ë–ö–ê: –õ–æ–≥–∏–Ω {{ message.chat.username }} –∏–ª–∏ chat_id {{ message.chat.id }} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    }
}
<% CASE ['/start', '/menu'] %>
{{ IF cmd != '/start' }}
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{{ END }}
{
    "sendPhoto": {
        "photo": "https://sun9-37.userapi.com/impg/kOLS5hVItY2R4a1usBE14wb1Ha7mOOVOmtwibw/ebjtbPjc5t4.jpg?size=1024x1024&quality=95&sign=c8ede94b62d73019612c143f67476c77&type=album", 
        "caption": "–°–æ–∑–¥–∞–≤–∞–π—Ç–µ VPN –∫–ª—é—á–∏ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –∏–º–∏",
        "reply_markup": {
            "inline_keyboard": [
                [
                    {
                        "text": "üí∞ –ë–∞–ª–∞–Ω—Å",
                        "callback_data": "/balance"
                    }
                ],
                [
                    {
                        "text": "üóù –°–ø–∏—Å–æ–∫ VPN –∫–ª—é—á–µ–π",
                        "callback_data": "/list"
                    }
                ],
                [
                    {
                        "text": "ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
                        "callback_data": "/referrals"
                    }
                ],
                [
                    {
                        "text": "üóì –ü–æ–º–æ—â—å",
                        "callback_data": "/help"
                    }
                ]
            ]
        }
    }
}

<% CASE '/balance' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendMessage": {
        "text": "üí∞ <b>–ë–∞–ª–∞–Ω—Å</b>: {{ user.balance }}\n\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å: <b>{{ user.pays.forecast('blocked',1).total }}</b>",
        "reply_markup" : {
            "inline_keyboard": [
                [
                    {
                        "text": "‚úö –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å",
                        "web_app": {
                            "url": "{{ config.api.url }}/shm/v1/public/tg_payment_webapp?format=html&user_id={{ user.id }}"
                          }
                    }
                ],
                [
                    {
                        "text": "‚ò∞ –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π",
                        "callback_data": "/pays"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/list' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendMessage": {
        "text": "üîë  –°–ø–∏—Å–æ–∫ VPN –∫–ª—é—á–µ–π",
        "reply_markup" : {
            "inline_keyboard": [
                {{ FOR item IN ref( user.services.list_for_api( 'category', '%' ) ) }}
                {{ SWITCH item.status }}
                  {{ CASE 'ACTIVE' }}
                  {{ icon = '‚úÖ' }}
                  {{ status = '–†–∞–±–æ—Ç–∞–µ—Ç' }}
                  {{ CASE 'BLOCK' }}
                  {{ icon = '‚ùå' }}
                  {{ status = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞' }}
                  {{ CASE 'NOT PAID' }}
                  {{ icon = 'üí∞' }}
                  {{ status = '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã' }}
                  {{ CASE }}
                  {{ icon = '‚è≥' }}
                  {{ status = '–û–±—Ä–∞–±–æ—Ç–∫–∞' }}
                {{ END }}
                [
                    {
                        "text": "{{ item.name }} - {{ icon }} {{ status }}",
                        "callback_data": "/service {{ item.user_service_id }}"
                    }
                ],
                {{ END }}
                [
                    {
                        "text": "‚úö –ö—É–ø–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á",
                        "callback_data": "/pricelist"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/service' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{{ item = us.id(args.0) }}
{{ us = user.services.list_for_api( 'usi', args.0 ) }}
{{ EXPIRE = BLOCK }}
    {{ USE date }}
    {{ date_sec = date.now }}
    {{ expire_sec = date.format(us.expire, '%s') }}
    {{ days_left = (expire_sec - date_sec) div 86400 }}
    {{ months = days_left div 30 }}
    {{ days = days_left % 30 }}
        {{ IF months == 0 }}
            {{ IF days == 1 }} 1 –¥–µ–Ω—å
            {{ ELSIF days == 2 or days == 3 or days == 4 }} {{ days }} –¥–Ω—è
            {{ ELSE }} {{ days }} –¥–Ω–µ–π
            {{ END }}
        {{ ELSE }}
            {{ IF months == 1 }}1 –º–µ—Å—è—Ü - 
            {{ ELSIF months == 2 or months == 3 or months == 4 }}{{ months }} –º–µ—Å—è—Ü–∞ - 
            {{ ELSE }}{{ months }} –º–µ—Å—è—Ü–µ–≤ - 
            {{ END }}
            {{ IF days > 0 }}
                {{ IF days == 1 }} 1 –¥–µ–Ω—å
                {{ ELSIF days == 2 or days == 3 or days == 4 }} {{ days }} –¥–Ω—è
                {{ ELSE }} {{ days }} –¥–Ω–µ–π
                {{ END }}
            {{ END }}
        {{ END }}
{{ END }}
{{ sub_url = storage.read('name','vpn_mrzb_' _ args.0 ).subscription_url }}
{{ bytes = http.get("$sub_url/info").used_traffic }}
{{ gb = bytes / 1073741824 FILTER format("%.0f") }}
{{ mb = (bytes % 1073741824) / 1048576 FILTER format("%.0f") }}
{
    "sendPhoto": {
        {{ SWITCH us.status }}
  {{ CASE 'ACTIVE' }}
  {{ icon = '‚úÖ' }}
  {{ status = '–†–∞–±–æ—Ç–∞–µ—Ç' }}
  {{ CASE 'BLOCK' }}
  {{ icon = 'üö´' }}
  {{ status = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞' }}
  {{ CASE 'NOT PAID' }}
  {{ icon = 'üí≥' }}
  {{ status = '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã' }}
  {{ CASE }}
  {{ icon = '‚è≥' }}
  {{ status = '–û–±—Ä–∞–±–æ—Ç–∫–∞' }}
{{ END }}
{{ TEXT = BLOCK }}
<b>–£—Å–ª—É–≥–∞</b>: {{ us.name }}
    {{ IF us.expire }}
<b>üóìÔ∏è –û–ø–ª–∞—á–µ–Ω–∞ –¥–æ</b>: {{ us.expire }}
    {{ END }}
<b>üìä –°—Ç–∞—Ç—É—Å</b>: {{ icon}} {{ status }}
    {{ IF mb == 0 }}
    {{ ELSE}}
        {{ IF gb >= 1 }}
üìà –ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ —Ç—Ä–∞—Ñ–∏–∫–∞: {{ gb }} Gb.{{ mb }} Mb
        {{ ELSE }}
üìà –ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ —Ç—Ä–∞—Ñ–∏–∫–∞: {{ mb }} Mb
        {{ END }}
    {{ END }}
{{ END }}
        "photo": "https://sun9-37.userapi.com/impg/kOLS5hVItY2R4a1usBE14wb1Ha7mOOVOmtwibw/ebjtbPjc5t4.jpg?size=1024x1024&quality=95&sign=c8ede94b62d73019612c143f67476c77&type=album",
        "caption": "{{ TEXT.replace('\n','\n') }}\nüìÖ –û—Å—Ç–∞–ª–æ—Å—å: {{ EXPIRE }}",
        "parse_mode": "HTML",
        "reply_markup": {
            "inline_keyboard": [
                {{ IF us.status == 'ACTIVE' }}
                {{ subscription_url = storage.read('name', 'vpn_mrzb_' _ args.0).subscription_url }}
                {{ IF us.category.grep('^(VPN)').first }}
                {{ IF subscription_url.grep('^https:').first }}
                [
                    {
                        "text": "üîó –ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É",
                        "callback_data": "/show_mz_keys {{ args.0 }}"
                    }
                ],
                {{ ELSE }}
                [
                    {
                        "text": "‚ö†Ô∏è –û–®–ò–ë–ö–ê: –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ SSL –¥–ª—è Marzban",
                        "callback_data": "/menu"
                    }
                ],
                {{ END }}
                {{ ELSE }}
                [
                    {
                        "text": "üóù –°–∫–∞—á–∞—Ç—å –∫–ª—é—á",
                        "callback_data": "/download_qr {{ args.0 }}"
                    },
                    {
                        "text": "üëÅ –ü–æ–∫–∞–∑–∞—Ç—å QR –∫–æ–¥",
                        "callback_data": "/show_qr {{ args.0 }}"
                    }
                ],
                {{ END }}
                {{ END }}
                  {{ IF us.status == 'NOT PAID' || us.status == 'BLOCK' }}
                [
                    {
                        "text": "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å",
                        "callback_data": "/balance {{ user.pays.forecast('blocked', 1).total }}"
                    }
                ],
                {{ END }}
                [
                    {
                        "text": "üîç –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é",
                        "callback_data": "/xray"
                    }
                ],
				[
                    {
                        "text": "üîÑ –°–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ",
                        "callback_data": "/change {{ args.0 }}"
                    }
                ],
				[
                    {
                        "text": "üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫",
                        "callback_data": "/service {{ args.0 }}"
                    }
                ],
				 {{ IF us.status != 'PROGRESS' }}
                [
                    {
                        "text": "üóë –£–¥–∞–ª–∏—Ç—å —É—Å–ª—É–≥—É",
                        "callback_data": "/delete {{ args.0 }}"
                    }
                ],
                {{ END }}
                [
                    {
                        "text": "‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —É—Å–ª—É–≥",
                        "callback_data": "/list"
                    }
                ]
            ]
        }
    }
}
<% CASE '/pricelist' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendMessage": {
        "text": "‚ò∑ –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –¥–ª—è –∑–∞–∫–∞–∑–∞",
        "reply_markup" : {
            "inline_keyboard": [
                {{ FOR item IN ref(service.api_price_list).nsort('service_id') }}
                [
                    {
                        "text": "{{ item.name }} - {{ item.cost }} —Ä—É–±",
                        "callback_data": "/serviceorder {{ item.service_id }}"
                    }
                ],
                {{ END }}
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/serviceorder' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "shmServiceOrder": {
        "service_id": "{{ args.0 }}",
        "callback_data": "/list",
        "cb_not_enough_money": "/balance",
        "error": "–û–®–ò–ë–ö–ê"
    }
}
<% CASE '/delete' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendMessage": {
        "text": "ü§î <b>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏. –£—Å–ª—É–≥—É –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å!</b>",
        "reply_markup" : {
            "inline_keyboard": [
                [
                    {
                        "text": "üß® –î–ê, –£–î–ê–õ–ò–¢–¨! üî•",
                        "callback_data": "/delete_confirmed {{ args.0 }}"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/list"
                    }
                ]
            ]
        }
    }
}
<% CASE '/delete_confirmed' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "shmServiceDelete": {
        "usi": "{{ args.0 }}",
        "callback_data": "/list",
        "error": "–û–®–ò–ë–ö–ê"
    }
}
<% CASE '/help' %>
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
},
{
    "sendPhoto": {
        "photo": "https://media.tenor.com/5KHjsG1Aw1YAAAAi/photos-google-photos.gif",
        "protect_content": "true",
        "parse_mode":"HTML",
        "caption": "1Ô∏è‚É£  –°–∫–∞—á–∞–π—Ç–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ WireGuard –∫ —Å–µ–±–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –°–∫–∞—á–∞—Ç—å –¥–ª—è <a href=\"https://apps.apple.com/us/app/wireguard/id1441195209\">iPhone</a>, <a href=\"https://play.google.com/store/apps/details?id=com.wireguard.android\">Android</a>, <a href=\"https://apps.apple.com/us/app/wireguard/id1451685025\">Mac</a>.\n\n2Ô∏è‚É£ –í —Ä–∞–∑–¥–µ–ª–µ \"–ö–ª—é—á–∏\" –Ω–∞–∂–º–∏—Ç–µ \"–ù–æ–≤—ã–π –∫–ª—é—á\" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –≤–∞–º.\n\n3Ô∏è‚É£  –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è WireGuard. –ù–∞—Ö–æ–¥—è—Å—å –≤ –º–µ–Ω—é \"–ö–ª—é—á–∏\" –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –∫–ª—é—á, –∫–ª–∏–∫–Ω—É–≤ –ø–æ –Ω–µ–º—É. –î–∞–ª–µ–µ —Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –∫–ª—é—á–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ WireGuard.",
        "reply_markup" : {
            "inline_keyboard": [
                [
                    {
                        "text": "–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
                        "url": "https://t.me/shm_billing"
                    }
                ],
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/pays' %>
{
    "sendMessage": {
        "text": "–ü–ª–∞—Ç–µ–∂–∏",
        "reply_markup" : {
            "inline_keyboard": [
                {{ FOR item IN ref(user.pays.list_for_api('limit', 5)) }}
                [
                    {
                        "text": "–î–∞—Ç–∞: {{ item.date }}, –°—É–º–º–∞: {{ item.money }} —Ä—É–±.",
                        "callback_data": "/menu"
                    }
                ],
                {{ END }}
                [
                    {
                        "text": "‚á¶ –ù–∞–∑–∞–¥",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/referrals' %>
{
    "sendMessage": {
        "text": "ü§ù –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞\n\n–ü—Ä–∏–≤–æ–¥–∏ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π {{ config.billing.partner.income_percent }}% —Å –∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π\n\n‚¨áÔ∏èÔ∏è –¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n‚îî https://t.me/NAME_bot?start={{ user.id }}\n\nüèÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n‚îú –ü—Ä–∏–≤–µ–¥–µ–Ω–æ –¥—Ä—É–∑–µ–π: {{ user.referrals_count }}\n‚îî –î–æ—Å—Ç—É–ø–Ω–æ –∫ –≤—ã–≤–æ–¥—É: {{ user.get_bonus }} ‚ÇΩ",
        "reply_markup": {
            "inline_keyboard": [
                [
                    {
                        "text": "–ù–∞–∑–∞–¥...",
                        "callback_data": "/menu"
                    }
                ]
            ]
        }
    }
}
<% CASE '/show_mz_keys' %>
{{ subscription_url = storage.read('name','vpn_mrzb_' _ args.0 ).subscription_url }}
{
    "printQrCode": {
        "data": "{{ subscription_url }}",
        "parameters": {
            "parse_mode": "HTML",
            "caption": "<b>Subscription URL:</b>\n<code>{{ subscription_url }}</code>"
        }
    }
},
{{ ss = storage.read('name','vpn_mrzb_' _ args.0 ).links.grep('^ss:').first }}
{
    "printQrCode": {
        "data": "{{ ss }}",
        "parameters": {
            "parse_mode": "HTML",
            "caption": "<b>ShadowSocks:</b>\n<code>{{ ss }}</code>"
        }
    }
},
{{ vless_tcp = storage.read('name','vpn_mrzb_' _ args.0 ).links.grep('^vless:').first }}
{
    "printQrCode": {
        "data": "{{ vless_tcp }}",
        "parameters": {
            "parse_mode": "HTML",
            "caption": "<b>VLESS TCP:</b>\n<code>{{ vless_tcp }}</code>"
        }
    }
}
<% CASE %>
{
    "sendMessage": {
        "text": "–û–®–ò–ë–ö–ê! –ë–æ—Ç –Ω–µ –∑–Ω–∞–µ—Ç –≤–≤–µ–¥–µ–Ω–Ω—É—é –≤–∞–º–∏ –∫–æ–º–∞–Ω–¥—É. –ï—Å–ª–∏ —É –í–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
    }
}
<% END %>
